---
title: "Exploratory Data Analysis"
author: "Tong Su, Shike Zhang"
date: "2024-12-05"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(plotly)
library(dplyr)
library(ggplot2)
```

```{r, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Data Import and Cleaning

```{r}
# Import the HIV and UHF datasets
HIV_df =
  read.csv("./data/HIV_AIDS_Diagnoses_by_Neighborhood__Sex__and_Race_Ethnicity_20241118.csv")|>
  janitor::clean_names()

UHF_df = 
  read.csv("./data/UHF_Neighborhoods.csv")|>
   janitor::clean_names()

# Clean HIV dataset
HIV_cleaned_df = HIV_df |>
  # Select rows where year 2016~2021
  filter(year >= 2016) |>
  # Convert Borough, Neighborhood (U.H.F), SEX, RACE/ETHNICITY to factors
  mutate(
    borough = as.factor(borough),
    neighborhood_u_h_f = as.factor(neighborhood_u_h_f),
    sex = as.factor(sex),
    race_ethnicity = as.factor(race_ethnicity)
  ) %>%
  # Convert necessary columns to numeric, handling non-numeric values
  mutate(
    total_number_of_hiv_diagnoses = as.numeric(total_number_of_hiv_diagnoses),
    hiv_diagnoses_per_100_000_population = as.numeric(hiv_diagnoses_per_100_000_population),
    total_number_of_concurrent_hiv_aids_diagnoses = as.numeric(total_number_of_concurrent_hiv_aids_diagnoses),
    proportion_of_concurrent_hiv_aids_diagnoses_among_all_hiv_diagnoses = as.numeric(proportion_of_concurrent_hiv_aids_diagnoses_among_all_hiv_diagnoses),
    total_number_of_aids_diagnoses = as.numeric(total_number_of_aids_diagnoses),
    aids_diagnoses_per_100_000_population = as.numeric(aids_diagnoses_per_100_000_population)
  )

# Merge datasets
HIV_UHF_df = HIV_cleaned_df |>
  inner_join(UHF_df, by = c("borough", "neighborhood_u_h_f" = "uhf_neighborhood"))
```

```{r}
# Export the merged data
write.csv(HIV_UHF_df, "Merged_HIV_UHF_Data.csv", row.names = FALSE)
```

### Data Dictionary

* YEAR: Year of diagnosis.

* Borough: Borough information (some missing values).

* Neighborhood (U.H.F): Specific neighborhood identifiers.

* SEX: Sex of individuals.

* RACE/ETHNICITY: Racial/ethnic group classifications.

* TOTAL NUMBER OF HIV DIAGNOSES: Counts of HIV diagnoses.

* HIV DIAGNOSES PER 100,000 POPULATION: Rate of diagnoses normalized by population.

* TOTAL NUMBER OF CONCURRENT HIV/AIDS DIAGNOSES: Concurrent diagnoses of HIV and AIDS.

* PROPORTION OF CONCURRENT HIV/AIDS DIAGNOSES: Percentage of concurrent diagnoses.

* TOTAL NUMBER OF AIDS DIAGNOSES: Counts of AIDS diagnoses.

* AIDS DIAGNOSES PER 100,000 POPULATION: Rate of AIDS diagnoses normalized by population.

### Data Summary

```{r, echo=FALSE}
skimr::skim(HIV_df)
```
## EDA
### Temporal trends
#### Temporal trends of HIV diagnoses
```{r, message=FALSE}
# Group by Borough and Year and calculate average HIV diagnosis rates
avg_hiv = HIV_UHF_df |>
  group_by(borough, year) |>
  summarise(Avg_HIV_Rate = mean(hiv_diagnoses_per_100_000_population, na.rm = TRUE))

avg_hiv
```

```{r}
# Plot HIV rates by Borough over time
ggplot(avg_hiv, aes(x = year, y = Avg_HIV_Rate, color = borough)) +
  geom_line(linewidth = 0.6) +
  geom_point(size = 1.5) +
  labs(
    title = "HIV Diagnosis Rates by Borough Over Time",
    x = "Year",
    y = "Average HIV Diagnosis Rate (Per 100,000 Population)",
    color = "Borough"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 10),
    legend.position = "bottom"
  )
```

#### Temporal trends of AID diagnoses
```{r}
# Group by Borough and Year and calculate average AIDS diagnosis rates
avg_aids = HIV_UHF_df |>
  group_by(borough, year) |>
  summarise(Avg_AIDS_Rate = mean(aids_diagnoses_per_100_000_population, na.rm = TRUE))

avg_aids
```


```{r}
# Temporal trends of AIDS diagnoses
ggplot(avg_aids, aes(x = year, y = Avg_AIDS_Rate, color = borough, group = borough)) +
  geom_line(size = 1) +
  geom_point() +
  labs(
    title = "Temporal Trends: AIDS Diagnosis Rates Across Boroughs",
    x = "Year",
    y = "Average AIDS Diagnosis Rate (Per 100,000 Population)",
    color = "Borough"
  ) +
  theme_minimal()


```

### Demographic Disparities
#### HIV Diagnoses by Sex and Race/Ethnicity
```{r}
# Group by Sex and Ethnicity with average rate of HIV
avghiv_sex_ethinicity = HIV_UHF_df |>
  group_by(borough, year,sex,race_ethnicity) |>
  summarise(Avg_HIV_Rate = mean(hiv_diagnoses_per_100_000_population, na.rm = TRUE))

avghiv_sex_ethinicity
```

```{r}
# Demographic disparities in HIV diagnoses
ggplot(avghiv_sex_ethinicity, aes(x = sex, y = Avg_HIV_Rate, fill = race_ethnicity)) +
  geom_boxplot() +
  labs(
    title = "Demographic Disparities: HIV Diagnosis Rates by Sex and Race/Ethnicity",
    x = "Sex",
    y = "Average HIV Diagnosis Rate (Per 100,000 Population)",
    fill = "Race/Ethnicity"
  ) +
  theme_minimal()

```

### Concurrent Diagnoses
#### Proportion of concurrent diagnoses by neighborhood
```{r}
# Group by proportion of concurrent diagnoses by neighborhood
proprotion_diagnoses_neighborhood = HIV_UHF_df |>
  group_by(borough, year,neighborhood_u_h_f) |>
  summarise(Avg_proportion_Rate = mean(proportion_of_concurrent_hiv_aids_diagnoses_among_all_hiv_diagnoses, na.rm = TRUE)
            )

proprotion_diagnoses_neighborhood
```

```{r}
ggplot(proprotion_diagnoses_neighborhood, aes(x = neighborhood_u_h_f, y = Avg_proportion_Rate,fill=borough)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Proportion of Concurrent Diagnoses by Neighborhood",
    x = "Neighborhood",
    y = "Average Proportion of Concurrent Diagnoses (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size=6))
```



#### Proportion of Concurrent Diagnoses by  Sex

```{r}
# Group by proportion of concurrent diagnoses by borough and sex with average rate of HIV
proprotion_diagnoses_sex = HIV_UHF_df |>
  group_by(borough, year,sex) |>
  summarise(Avg_proportion_Rate = mean(proportion_of_concurrent_hiv_aids_diagnoses_among_all_hiv_diagnoses, na.rm = TRUE)
            )

proprotion_diagnoses_sex
```
```{r}
# Concurrent diagnoses by borough and sex
ggplot(proprotion_diagnoses_sex, aes(x = borough, y = as.numeric(Avg_proportion_Rate), fill = sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Proportion of Concurrent Diagnoses by Borough and Sex",
    x = "Borough",
    y = "AverageProportion of Concurrent Diagnoses (%)",
    fill = "Sex"
  ) +
  theme_minimal()

```

#### Proportion of Concurrent Diagnoses by Race/Ethnicity

```{r}
# Group by proportion of concurrent diagnoses by borough and ethnicity with average rate of HIV
proprotion_diagnoses_race = HIV_UHF_df |>
  group_by(borough, year,race_ethnicity) |>
  summarise(Avg_proportion_Rate = mean(proportion_of_concurrent_hiv_aids_diagnoses_among_all_hiv_diagnoses, na.rm = TRUE)
            )

proprotion_diagnoses_race
```


```{r}
# Concurrent diagnoses by race/ethnicity and borough
ggplot(proprotion_diagnoses_race, aes(x = race_ethnicity, y = as.numeric(Avg_proportion_Rate), fill = borough)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Proportion of Concurrent Diagnoses by Race/Ethnicity and Borough",
    x = "Race/Ethnicity",
    y = "Average Proportion of Concurrent Diagnoses (%)",
    fill = "Borough"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

